#!/bin/bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–±–æ—Ä–∫–∞ DMG —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞ –¥–ª—è macOS
# XML Editor Desktop

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "========================================"
echo "  XML Editor Desktop - Mac Builder"
echo "========================================"
echo ""

# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∫–æ–Ω–∫–∏
echo "[1/6] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∫–æ–Ω–∫–∏..."
if [ ! -f "build/icon.png" ]; then
    echo "‚ö†Ô∏è  –û–®–ò–ë–ö–ê: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç build/icon.png!"
    echo ""
    echo "–°–æ–∑–¥–∞—é –≤—Ä–µ–º–µ–Ω–Ω—É—é –∏–∫–æ–Ω–∫—É..."
    mkdir -p build
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—É—é –∏–∫–æ–Ω–∫—É –¥–æ–∫—É–º–µ–Ω—Ç–∞
    sips -s format png /System/Library/CoreServices/CoreTypes.bundle/Contents/Resources/GenericDocumentIcon.icns --out build/icon.png --resampleWidth 512 2>/dev/null || {
        echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∏–∫–æ–Ω–∫—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"
        echo "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–º–µ—Å—Ç–∏—Ç–µ —Ñ–∞–π–ª icon.png (512x512) –≤ –ø–∞–ø–∫—É build/"
        exit 1
    }
    echo "‚úÖ –í—Ä–µ–º–µ–Ω–Ω–∞—è –∏–∫–æ–Ω–∫–∞ —Å–æ–∑–¥–∞–Ω–∞"
else
    echo "‚úÖ –ò–∫–æ–Ω–∫–∞ –Ω–∞–π–¥–µ–Ω–∞"
fi

# 2. –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±–∏–ª–¥–æ–≤
echo ""
echo "[2/6] –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±–∏–ª–¥–æ–≤..."
rm -rf dist/
echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

# 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo ""
echo "[3/6] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
if [ ! -d "node_modules" ]; then
    npm install
    echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
else
    echo "‚è≠Ô∏è  node_modules —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
    echo "   (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞, —É–¥–∞–ª–∏—Ç–µ node_modules/ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–æ–≤–∞)"
fi

# 4. –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –Ω–∞—Ç–∏–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π
echo ""
echo "[4/6] –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –Ω–∞—Ç–∏–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π –¥–ª—è macOS..."
npm run rebuild:native
echo "‚úÖ –ù–∞—Ç–∏–≤–Ω—ã–µ –º–æ–¥—É–ª–∏ –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω—ã"

# 5. –°–±–æ—Ä–∫–∞ DMG
echo ""
echo "[5/6] –°–±–æ—Ä–∫–∞ DMG —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞..."
echo "‚è≥ –≠—Ç–æ –∑–∞–π–º—ë—Ç 3-5 –º–∏–Ω—É—Ç..."
npm run build:mac

echo ""
echo "========================================"
echo "  ‚úÖ –°–ë–û–†–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê!"
echo "========================================"
echo ""
echo "–†–µ–∑—É–ª—å—Ç–∞—Ç:"
ls -lh dist/*.dmg dist/*.zip 2>/dev/null || echo "–§–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
echo ""
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –ø–∞–ø–∫–µ dist/"
echo ""
echo "‚ö†Ô∏è  –í–ê–ñ–ù–û: –ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å–æ–∑–¥–∞–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é:"
echo "   –ö–∞–∫ –æ–±–æ–π—Ç–∏ Gatekeeper (—Å–º. –Ω–∏–∂–µ)"
echo ""
echo "üîß –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π Mac:"
echo "   xattr -cr '/Applications/XML Editor Desktop.app'"
echo ""