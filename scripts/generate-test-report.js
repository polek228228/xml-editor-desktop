#!/usr/bin/env node

/**
 * @file generate-test-report.js
 * @description Generate comprehensive E2E test coverage report
 */

const fs = require('fs');
const path = require('path');

const RESULTS_PATH = path.join(__dirname, '../test-results/test-results.json');
const REPORT_PATH = path.join(__dirname, '../E2E_TEST_REPORT.md');

// Check if results file exists
if (!fs.existsSync(RESULTS_PATH)) {
  console.error('âŒ Test results not found. Run tests first: npm run test:e2e');
  process.exit(1);
}

// Read test results
const results = JSON.parse(fs.readFileSync(RESULTS_PATH, 'utf8'));

// Calculate statistics
let totalTests = 0;
let passedTests = 0;
let failedTests = 0;
let skippedTests = 0;
const suiteResults = [];

results.suites.forEach(suite => {
  const suiteStats = {
    file: suite.file,
    title: suite.title,
    passed: 0,
    failed: 0,
    skipped: 0,
    tests: []
  };

  suite.specs.forEach(spec => {
    totalTests++;

    if (spec.ok && !spec.tests[0]?.results[0]?.error) {
      passedTests++;
      suiteStats.passed++;
      suiteStats.tests.push({ title: spec.title, status: 'passed' });
    } else if (spec.tests[0]?.results[0]?.status === 'skipped') {
      skippedTests++;
      suiteStats.skipped++;
      suiteStats.tests.push({ title: spec.title, status: 'skipped' });
    } else {
      failedTests++;
      suiteStats.failed++;
      suiteStats.tests.push({
        title: spec.title,
        status: 'failed',
        error: spec.tests[0]?.results[0]?.error?.message || 'Unknown error'
      });
    }
  });

  suiteResults.push(suiteStats);
});

const passRate = totalTests > 0 ? ((passedTests / totalTests) * 100).toFixed(1) : 0;
const timestamp = new Date().toISOString().split('T')[0];

// Generate report
const report = `# E2E Test Report
**Generated:** ${timestamp}
**Framework:** Playwright 1.55.1

---

## ğŸ“Š Executive Summary

| Metric | Value |
|--------|-------|
| **Total Tests** | ${totalTests} |
| **âœ… Passed** | ${passedTests} |
| **âŒ Failed** | ${failedTests} |
| **â­ï¸ Skipped** | ${skippedTests} |
| **Pass Rate** | ${passRate}% |

${passRate >= 90 ? 'ğŸ‰ **Excellent!** Pass rate above 90%' : passRate >= 75 ? 'ğŸ‘ **Good** Pass rate above 75%' : 'âš ï¸ **Needs attention** Pass rate below 75%'}

---

## ğŸ“ Test Suites Breakdown

${suiteResults.map(suite => `
### ${suite.title || path.basename(suite.file)}
**File:** \`${suite.file}\`

| Status | Count |
|--------|-------|
| âœ… Passed | ${suite.passed} |
| âŒ Failed | ${suite.failed} |
| â­ï¸ Skipped | ${suite.skipped} |

#### Tests:
${suite.tests.map(test => {
  if (test.status === 'passed') {
    return `- âœ… ${test.title}`;
  } else if (test.status === 'failed') {
    return `- âŒ ${test.title}\n  \`\`\`\n  ${test.error}\n  \`\`\``;
  } else {
    return `- â­ï¸ ${test.title}`;
  }
}).join('\n')}
`).join('\n---\n')}

---

## ğŸ” Failed Tests Analysis

${failedTests === 0 ? 'âœ… **No failed tests!**' : `
### Issues Found:

${suiteResults.flatMap(suite =>
  suite.tests
    .filter(t => t.status === 'failed')
    .map(t => `
#### âŒ ${t.title}
**File:** \`${suite.file}\`
**Error:**
\`\`\`
${t.error}
\`\`\`
`)
).join('\n')}
`}

---

## ğŸ“ˆ Recommendations

${passRate >= 90 ? `
âœ… Excellent test coverage! Consider:
- Adding visual regression tests
- Implementing accessibility testing
- Setting up performance benchmarks
` : passRate >= 75 ? `
ğŸ‘ Good progress! Next steps:
- Fix remaining ${failedTests} failing test(s)
- Increase test coverage to 90%+
- Add edge case testing
` : `
âš ï¸ Action required:
- **Priority:** Fix ${failedTests} failing tests
- Review test infrastructure
- Ensure app functionality matches test expectations
`}

---

## ğŸš€ Running Tests

\`\`\`bash
# Run all tests
npm run test:e2e

# Run specific suite
npm run test:e2e:smoke
npm run test:e2e:docs
npm run test:e2e:templates
npm run test:e2e:ui

# View results
npm run test:e2e:report
\`\`\`

---

**Report generated by:** \`npm run test:report\`
**Timestamp:** ${new Date().toISOString()}
`;

// Write report
fs.writeFileSync(REPORT_PATH, report, 'utf8');

console.log('âœ… Test report generated successfully!');
console.log(`ğŸ“„ Report saved to: ${REPORT_PATH}`);
console.log('');
console.log('ğŸ“Š Summary:');
console.log(`   Total Tests: ${totalTests}`);
console.log(`   âœ… Passed: ${passedTests}`);
console.log(`   âŒ Failed: ${failedTests}`);
console.log(`   Pass Rate: ${passRate}%`);
console.log('');
console.log('View report: cat E2E_TEST_REPORT.md');
